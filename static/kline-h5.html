<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kçº¿å›¾è¡¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f6f7fb;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chart-wrapper {
            flex: 1;
            padding: 10px;
            background: #fff;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        #main-chart {
            flex: 1;
            min-height: 300px;
            width: 100%;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            font-size: 16px;
        }
        
        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #f56565;
            font-size: 16px;
            text-align: center;
            flex-direction: column;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="chart-wrapper">
        <div id="main-chart" class="loading">æ­£åœ¨åŠ è½½Kçº¿æ•°æ®...</div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script>
        let chart = null;
        let chartData = [];
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('main-chart');
            chartDom.innerHTML = '';
            
            try {
                chart = echarts.init(chartDom);
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    if (chart) {
                        chart.resize();
                    }
                });
                
                // å¦‚æœæœ‰åˆå§‹æ•°æ®åˆ™æ¸²æŸ“
                if (chartData && chartData.length > 0) {
                    renderChart();
                } else {
                    // ç”Ÿæˆé»˜è®¤ç¤ºä¾‹æ•°æ®
                    generateSampleData();
                    renderChart();
                }
                
            } catch (error) {
                console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
                showError('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥');
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const chartDom = document.getElementById('main-chart');
            chartDom.innerHTML = `
                <div class="error">
                    <div class="error-icon">ğŸ“ˆ</div>
                    <div>${message}</div>
                    <div style="font-size: 12px; margin-top: 10px; color: #999;">
                        è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•
                    </div>
                </div>
            `;
        }
        
        // ç”Ÿæˆç¤ºä¾‹æ•°æ®
        function generateSampleData() {
            chartData = [];
            const now = new Date();
            let basePrice = 50000;
            
            for (let i = 50; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000);
                const open = basePrice + (Math.random() - 0.5) * 500;
                const close = open + (Math.random() - 0.5) * 300;
                const high = Math.max(open, close) + Math.random() * 100;
                const low = Math.min(open, close) - Math.random() * 100;
                const volume = 1000 + Math.random() * 2000;
                
                chartData.push({
                    time: formatTime(time),
                    open: +open.toFixed(2),
                    close: +close.toFixed(2),
                    high: +high.toFixed(2),
                    low: +low.toFixed(2),
                    volume: +volume.toFixed(0)
                });
                
                basePrice = close;
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // æ¸²æŸ“å›¾è¡¨
        function renderChart() {
            if (!chart || !chartData || chartData.length === 0) return;
            
            try {
                const upColor = '#00da3c';
                const downColor = '#ec0000';
                
                const categoryData = chartData.map(item => item.time);
                const values = chartData.map(item => [item.open, item.close, item.low, item.high]);
                
                const option = {
                    backgroundColor: '#fff',
                    animation: true,
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        backgroundColor: 'rgba(50, 50, 50, 0.7)',
                        textStyle: { color: '#fff' },
                        borderWidth: 0,
                        formatter: function (params) {
                            const data = params[0];
                            if (!data || !data.data) return '';
                            
                            const [open, close, low, high] = data.data;
                            return `
                                <div style="font-size: 12px;">
                                    <div style="margin-bottom: 5px; font-weight: bold;">${data.name}</div>
                                    <div>å¼€ç›˜: ${open}</div>
                                    <div>æ”¶ç›˜: ${close}</div>
                                    <div>æœ€é«˜: ${high}</div>
                                    <div>æœ€ä½: ${low}</div>
                                </div>
                            `;
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        top: '10%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: categoryData,
                        boundaryGap: false,
                        axisLine: { 
                            lineStyle: { color: '#8392A5' }
                        },
                        axisTick: { 
                            lineStyle: { color: '#8392A5' }
                        },
                        axisLabel: { 
                            textStyle: { color: '#8392A5' },
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        scale: true,
                        axisLine: { 
                            lineStyle: { color: '#8392A5' }
                        },
                        axisTick: { 
                            lineStyle: { color: '#8392A5' }
                        },
                        axisLabel: { 
                            textStyle: { color: '#8392A5' },
                            fontSize: 10
                        },
                        splitLine: {
                            lineStyle: { 
                                color: ['#E9EEF3'],
                                type: 'dashed'
                            }
                        }
                    },
                    series: [{
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: values,
                        itemStyle: {
                            color: upColor,
                            color0: downColor,
                            borderColor: upColor,
                            borderColor0: downColor,
                            borderWidth: 1
                        },
                        barWidth: '60%'
                    }]
                };
                
                chart.setOption(option, true);
                
            } catch (error) {
                console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
                showError('å›¾è¡¨æ¸²æŸ“å¤±è´¥');
            }
        }
        
        // æ›´æ–°æ•°æ®çš„æ–¹æ³•ï¼Œä¾›å¤–éƒ¨è°ƒç”¨
        window.updateKlineData = function(data) {
            if (!data || !Array.isArray(data)) {
                console.warn('æ— æ•ˆçš„Kçº¿æ•°æ®');
                return;
            }
            
            chartData = data;
            if (chart) {
                renderChart();
            }
        };
        
        // è·å–å½“å‰æ•°æ®
        window.getKlineData = function() {
            return chartData;
        };
        
        // æ¸…ç©ºæ•°æ®
        window.clearKlineData = function() {
            chartData = [];
            if (chart) {
                chart.clear();
            }
        };
        
        // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data) {
                switch(event.data.type) {
                    case 'updateData':
                        window.updateKlineData(event.data.data);
                        break;
                    case 'clearData':
                        window.clearKlineData();
                        break;
                }
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                try {
                    initChart();
                } catch (error) {
                    console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                    showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥');
                }
            }, 100);
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', function() {
            if (chart) {
                chart.dispose();
                chart = null;
            }
        });
    </script>
</body>
</html>